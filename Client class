package client;

import java.awt.BorderLayout;
import java.awt.HeadlessException;
import java.awt.event.*;
import java.io.*;
import java.net.Socket;
import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;

import javax.swing.*;

/**
 * @author ilnaz-92@yandex.ru
 * Created on 2019-03-07
 */
public class Client extends JFrame
{

  private final String SERVER_HOST = "localhost";
  private final int SERVER_PORT = 8899;
  private Socket clientSocket;
  private Scanner inMsg;
  private PrintWriter outMsg;
  private JTextField jtfMsg;
  private JTextField jtfName;
  private JTextArea jTextAreaMsg;

  private String clientHistoryFile = "ClientHistory1.txt";
  private int historyAmount = 11;

  public Client() throws HeadlessException
  {
    try
    {
      clientSocket = new Socket(SERVER_HOST, SERVER_PORT);
      inMsg = new Scanner(clientSocket.getInputStream());
      outMsg = new PrintWriter(clientSocket.getOutputStream());
    }
    catch (Exception e)
    {
      e.printStackTrace();
    }

    setBounds(500, 300, 500, 400);
    setTitle("Client of chat");
    setDefaultCloseOperation(WindowConstants.EXIT_ON_CLOSE);
    jTextAreaMsg = new JTextArea();
    jTextAreaMsg.setEditable(false);
    jTextAreaMsg.setLineWrap(true);

    JScrollPane jScrollPane = new JScrollPane(jTextAreaMsg);
    add(jScrollPane, BorderLayout.CENTER);

    JLabel labelCountOfClient = new JLabel("Count of client in chat : ");
    add(labelCountOfClient, BorderLayout.NORTH);

    JPanel bottomPanel = new JPanel(new BorderLayout());
    add(bottomPanel, BorderLayout.SOUTH);

    JLabel countsOfClientLabel = new JLabel("Counts of clients in chat :");
    add(countsOfClientLabel, BorderLayout.NORTH);

    JButton sendButton = new JButton("SEND");
    bottomPanel.add(sendButton, BorderLayout.EAST);

    jtfMsg = new JTextField("Please input your msg");
    bottomPanel.add(jtfMsg, BorderLayout.CENTER);

    jtfName = new JTextField("Your name");
    bottomPanel.add(jtfName, BorderLayout.WEST);

    sendButton.addActionListener(new ActionListener()
    {
      @Override
      public void actionPerformed(ActionEvent e)
      {
        String msg = jtfMsg.getText().trim();
        String name = jtfName.getText().trim();

        if ((!msg.isEmpty() && !name.isEmpty()) && (!name.equalsIgnoreCase( "Your name")))
        {
          sendMsg();
          jtfMsg.grabFocus();
          writeClientHistory(clientHistoryFile, name, msg);
          //List<String> readHistory = readClientHistory(clientHistoryFile);

        } else {
          outMsg.println("Please, enter your name or text before send a message!");
          outMsg.flush();
        }
      }
    });

    jtfMsg.addFocusListener(new FocusAdapter()
    {
      @Override
      public void focusGained(FocusEvent e)
      {
        jtfMsg.setText("");
      }
    });
    jtfName.addFocusListener(new FocusAdapter()
    {
      @Override
      public void focusGained(FocusEvent e)
      {
        jtfName.setText("");
      }
    });

    new Thread(new Runnable()
    {
      @Override
      public void run()
      {

        while (true)
        {
          if (inMsg.hasNext())
          {
            String msg = inMsg.nextLine();
            String clientInChat = "Counts of clients in chat : ";
            if (msg.indexOf(clientInChat) == 0)
            {
              countsOfClientLabel.setText(clientInChat);
            }
            else
            {
              jTextAreaMsg.append(msg);
              jTextAreaMsg.append("\n");

            }

          }
        }
      }
    }).start();


    List<String> readHistory = readClientHistory(clientHistoryFile);
    if (readHistory.size()-historyAmount <0) {
      historyAmount = readHistory.size() - 0;
    }
    for (int i = readHistory.size()-historyAmount; i < readHistory.size() ; i++) {
      String curS = readHistory.get(i);

      if (curS != null) {
        jTextAreaMsg.append(curS);
      } else {
        break;
      }
    }

    addWindowListener(new WindowAdapter()
    {
      @Override
      public void windowClosing(WindowEvent e)
      {
        super.windowClosing(e);
        String clientName = jtfName.getText();
        if (!clientName.isEmpty() && !clientName.equalsIgnoreCase("Your name"))
        {
          outMsg.println(clientName + " exited from chat.");
        }
        else
        {
          outMsg.println("Anonnym client exited from our chat");
        }

        outMsg.println("QUIT");
        outMsg.flush();
        outMsg.close();
        inMsg.close();
        try
        {
          clientSocket.close();
        }
        catch (IOException e1)
        {
          e1.printStackTrace();
        }


      }
    });
    setVisible(true);
  }

  private void sendMsg()
  {
    String msg = jtfName.getText() + ":" + jtfMsg.getText();
    outMsg.println(msg);
    outMsg.flush();
    jtfMsg.setText("");
  }


  private List<String> readClientHistory (String clientHistoryFile) {
    List<String> readHistory = new ArrayList<>();
    String s = null;

    try {
      BufferedReader br = new BufferedReader(new FileReader(clientHistoryFile));

      while ((s = br.readLine()) != null) {
        readHistory.add(s + "\n");
      }

      br.close();
    } catch (Exception e) {
      e.printStackTrace();
    }


    return readHistory;
  }


  private void writeClientHistory (String clientHistoryFile, String name, String msg) {
    BufferedWriter bw = null;
    List<String> readHistory = readClientHistory(clientHistoryFile);

    try {
      bw = new BufferedWriter(new FileWriter(clientHistoryFile));
      readHistory.add(name + ": " + msg + "\n");
      for (int i = 0; i < readHistory.size(); i++) {
        bw.write(readHistory.get(i));
      }
      bw.close();
    } catch (Exception e) {
      e.printStackTrace();
    }

  }
}
